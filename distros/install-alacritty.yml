- name: Install Rust via rustup (user-local)
  become: no
  shell: |
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  args:
    creates: "{{ lookup('env','HOME') }}/.cargo/bin/rustc"

- name: Ensure ~/.cargo/bin is in PATH for this playbook
  shell: |
    export PATH="{{ lookup('env','HOME') }}/.cargo/bin:$PATH"
  args:
    executable: /bin/bash

- name: Clone Alacritty repository
  git:
    repo: https://github.com/alacritty/alacritty.git
    dest: "{{ lookup('env','HOME') }}/.local/src/alacritty"
    update: yes

- name: Install stable Rust toolchain (explicit)
  shell: "{{ lookup('env','HOME') }}/.cargo/bin/rustup install stable"
  args:
    creates: "{{ lookup('env','HOME') }}/.rustup/toolchains/stable-{{ ansible_architecture | default('x86_64') }}-unknown-linux-gnu"

- name: Set default Rust toolchain to stable (optional, harmless)
  shell: "{{ lookup('env','HOME') }}/.cargo/bin/rustup default stable"
  args:
    creates: "{{ lookup('env','HOME') }}/.rustup/settings.toml"

# Optional debug tasks (temporarily useful)
- name: Show rustup state (debug)
  shell: |
    export HOME="{{ lookup('env','HOME') }}"
    {{ lookup('env','HOME') }}/.cargo/bin/rustup show || true
  args:
    executable: /bin/bash
  register: rustup_show
- debug:
    var: rustup_show.stdout_lines

# The reliable build: use `rustup run stable cargo` so we don't depend on "default"
- name: Build Alacritty (use rustup run stable)
  shell: |
    export HOME="{{ lookup('env','HOME') }}"
    export CARGO_HOME="{{ lookup('env','HOME') }}/.cargo"
    export RUSTUP_HOME="{{ lookup('env','HOME') }}/.rustup"
    source "{{ lookup('env','HOME') }}/.cargo/env" || true
    cd "{{ lookup('env','HOME') }}/.local/src/alacritty"
    "{{ lookup('env','HOME') }}/.cargo/bin/rustup" run stable cargo build --release
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ lookup('env','HOME') }}/.cargo/bin:{{ ansible_env.PATH }}"


- name: Copy Alacritty binary to /usr/local/bin
  copy:
      src: "{{ lookup('env', 'HOME') }}/.local/src/alacritty/target/release/alacritty"
      dest: /usr/local/bin/alacritty
      mode: "0755"
  become: yes
- name: Copy Alacritty binary
  copy:
      src: "{{ lookup('env', 'HOME') }}/.local/src/alacritty/target/release/alacritty"
      dest: /usr/local/bin/alacritty
      mode: "0755"

- name: Install Alacritty desktop entry
  copy:
      src: "{{ lookup('env', 'HOME') }}/.local/src/alacritty/extra/linux/Alacritty.desktop"
      dest: /usr/share/applications/Alacritty.desktop
      mode: "0644"
      remote_src: yes

- name: Update desktop database
  command: desktop-file-install /usr/share/applications/Alacritty.desktop
